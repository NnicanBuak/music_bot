version: "3.9"

services:
   traefik:
      image: traefik:v3.0
      restart: always
      command:
         - "--api.dashboard=true"
         - "--providers.docker=true"
         - "--providers.docker.exposedbydefault=false"
         - "--entrypoints.web.address=:80"
         - "--accesslog=true"
         - "--log.level=INFO"
         - "--ping=true"
         - "--ping.entrypoint=web"
      ports:
         - "80:80"
         - "8080:8080"
      volumes:
         - /var/run/docker.sock:/var/run/docker.sock:ro
         - traefik-logs:/var/log/traefik
      networks:
         - backend
      healthcheck:
         test: ["CMD", "traefik", "healthcheck", "--ping"]
         interval: 10s
         timeout: 3s
         retries: 3
      logging:
         driver: "json-file"
         options:
            max-size: "10m"
            max-file: "3"

   redis:
      image: redis:7-alpine
      restart: always
      env_file: ../.env
      volumes:
         - redis-prod-data:/data
      command: ["--requirepass", "${REDIS_PASSWORD}"]
      networks:
         - backend
      deploy:
         resources:
            limits:
               memory: 512M
               cpus: "0.5"
            reservations:
               memory: 256M
      healthcheck:
         test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
         interval: 10s
         timeout: 3s
         retries: 3
         start_period: 5s
      logging:
         driver: "json-file"
         options:
            max-size: "10m"
            max-file: "3"

   postgres:
      image: postgres:16-alpine
      restart: always
      env_file: ../.env
      environment:
         POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
         POSTGRES_USER: ${POSTGRES_USER}
         POSTGRES_DB: ${POSTGRES_DB}
         PGDATA: /var/lib/postgresql/data
      volumes:
         - postgres-prod-data:/var/lib/postgresql/data
      networks:
         - backend
      deploy:
         resources:
            limits:
               memory: 1G
               cpus: "1.0"
            reservations:
               memory: 512M
      healthcheck:
         test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER}"]
         interval: 10s
         timeout: 5s
         retries: 5
         start_period: 10s
      logging:
         driver: "json-file"
         options:
            max-size: "10m"
            max-file: "3"

   bot:
      image: ghcr.io/nnicanbuak/music_bot:${IMAGE_TAG:-latest}
      restart: always
      env_file: ../.env
      depends_on:
         redis:
            condition: service_healthy
         postgres:
            condition: service_healthy
      networks:
         - backend
      deploy:
         replicas: 1
         resources:
            limits:
               memory: 2G
               cpus: "2.0"
            reservations:
               memory: 1G
      labels:
         - "traefik.enable=true"
         - "traefik.http.routers.bot.rule=PathPrefix(`/`)"
         - "traefik.http.routers.bot.entrypoints=web"
         - "traefik.http.services.bot.loadbalancer.server.port=${SERVER_PORT}"
         # Health check for Traefik
         - "traefik.http.services.bot.loadbalancer.healthcheck.path=/health/readiness"
         - "traefik.http.services.bot.loadbalancer.healthcheck.interval=10s"
         - "traefik.http.services.bot.loadbalancer.healthcheck.timeout=5s"
         # Graceful shutdown
         - "traefik.http.services.bot.loadbalancer.healthcheck.followredirects=true"
      healthcheck:
         test: ["CMD-SHELL", "curl -f http://localhost:${SERVER_PORT}/health/readiness || exit 1"]
         interval: 30s
         timeout: 10s
         retries: 3
         start_period: 90s
      entrypoint: ["/app/scripts/run-bot.sh"]
      logging:
         driver: "json-file"
         options:
            max-size: "10m"
            max-file: "3"

volumes:
   redis-prod-data:
   postgres-prod-data:
   traefik-logs:

networks:
   backend:
      driver: bridge
