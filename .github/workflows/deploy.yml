name: Deploy to Production

on:
   push:
      branches: [main]
   workflow_dispatch:

jobs:
   deploy:
      runs-on: ubuntu-latest
      steps:
         - uses: actions/checkout@v4

         - name: Deploy to server
           uses: appleboy/ssh-action@v1.0.0
           with:
              host: ${{ secrets.PROD_HOST }}
              username: ${{ secrets.PROD_USER }}
              key: ${{ secrets.SSH_PRIVATE_KEY }}
              script: |
                 cd /opt/nnican_music_bot
                 git pull origin main

                 chmod +x deploy/scripts/deploy.sh
                 ./deploy/scripts/deploy.sh

                 cd deploy
                 docker compose exec -T bot uv run alembic upgrade head

         - name: Notify on failure
           if: failure()
           run: |
              echo "‚ùå Deployment failed - check logs"
